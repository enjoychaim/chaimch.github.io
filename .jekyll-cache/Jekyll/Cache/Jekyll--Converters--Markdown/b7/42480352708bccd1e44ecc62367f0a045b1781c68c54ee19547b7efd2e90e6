I"›¨<h2 id="é—®é¢˜">é—®é¢˜</h2>

<ol>
  <li>kubernates æ˜¯ä»€ä¹ˆï¼Ÿ</li>
  <li>kubernates è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li>
  <li>kubernates è¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ</li>
  <li>é›†ç¾¤ä¸­èµ„æºæ˜¯å¦‚ä½•è°ƒåº¦çš„ï¼Ÿ</li>
</ol>

<h2 id="k8s-æ˜¯ä»€ä¹ˆ-è§£å†³äº†ä»€ä¹ˆé—®é¢˜">k8s æ˜¯ä»€ä¹ˆ, è§£å†³äº†ä»€ä¹ˆé—®é¢˜</h2>

<p>kubernates æ˜¯ Google å…¬å¸å¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’ä¸è°ƒåº¦ç®¡ç†æ¡†æ¶, å½“å‰ç”± CNCF æ‰˜ç®¡.</p>

<p>è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿæƒ…å†µä¸‹, å®¹å™¨çš„ç¼–æ’ä¸è°ƒåº¦é—®é¢˜.</p>

<h3 id="å‘å±•å†å²">å‘å±•å†å²</h3>

<ol>
  <li>
    <p>2003-2004 å¹´, Google å‘å¸ƒ Borg ç³»ç»Ÿ, 3-4 äººå¼€å‘.</p>

    <p>ä¸»è¦ç”¨äºç®¡ç†é•¿æ—¶é—´è¿è¡Œçš„ç”Ÿäº§æœåŠ¡å’Œæ‰¹å¤„ç†æœåŠ¡. Brog å°†ä¸Šè¿°ä¸¤ç§æœåŠ¡æ‰€éœ€è¦çš„çš„æœºå™¨ç»Ÿä¸€æˆä¸€ä¸ªæ± å­, ä»¥ä¾¿æé«˜èµ„æºåˆ©ç”¨ç‡, åŒæ—¶é™ä½æˆæœ¬.</p>

    <p>ä¹‹æ‰€ä»¥èƒ½å¤Ÿå®ç°è·¨æœºå™¨çš„èµ„æºå…±äº«ä»¥åŠè¿›ç¨‹éš”ç¦», æ˜¯å› ä¸ºå¯ä»¥æ‹¿åˆ° Linux å†…æ ¸çš„å®¹å™¨æ”¯æŒ.</p>
  </li>
  <li>
    <p>â€¦ å¹´, è¶Šæ¥è¶Šå¤šçš„åº”ç”¨è¢«å¼€å‘å¹¶è¿è¡Œåœ¨ Borgä¸Š, Google å›¢é˜Ÿå¼€å‘äº†ä¸€ä¸ªå·¥å…·ç³»ç»Ÿ.</p>

    <p>å·¥å…·ç³»ç»Ÿæä¾›é…åˆå’Œæ›´æ–° job çš„æœºåˆ¶, å¯ä»¥é¢„æµ‹èµ„æºéœ€æ±‚, åŠ¨æ€çš„æ¨é€é…ç½®æ–‡ä»¶, æœåŠ¡å‘ç°, è´Ÿè½½å‡è¡¡, è‡ªåŠ¨æ‰©å®¹, æœºå™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†, é¢åº¦ç®¡ç†ç­‰ç­‰.</p>

    <p>ç”±äºè¦é€‚é…ä¸åŒå›¢é˜Ÿçš„éœ€æ±‚, Borg å‘å±•æˆäº† ad-hoc ç³»ç»Ÿ(å³å¸­æŸ¥è¯¢, ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œçµæ´»çš„é€‰æ‹©æŸ¥è¯¢æ¡ä»¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ç”Ÿæˆç›¸åº”çš„ç»Ÿè®¡æŠ¥è¡¨)é›†åˆ, Borg ä½¿ç”¨è€…å¯ä»¥ä½¿ç”¨ä¸åŒçš„é…ç½®è¯­è¨€å’Œè¿›ç¨‹æ¥é…ç½®ä¸æ²Ÿé€š.</p>
  </li>
  <li>
    <p>2006-2007 å¹´, Paul Menageå’ŒRohit Seth æå‡ºäº† cgroups, å¹¶ä¸”è¢«åˆå¹¶åˆ°2.6.24ç‰ˆçš„å†…æ ¸ä¸­</p>
  </li>
  <li>
    <p>2013 å¹´å·¦å³, å¤„äºæå‡ Borg ç”Ÿæ€ç³»ç»Ÿè½¯ä»¶å·¥ç¨‹çš„æ„¿æ™¯, Google å‘å¸ƒäº† Omega é›†ç¾¤ç®¡ç†ç³»ç»Ÿ.</p>

    <p>Omega æŠŠå¾ˆå¤š Borg å†…å·²ç»è¢«è®¤è¯çš„æˆåŠŸçš„æ¨¡å¼æ¬è¿‡æ¥, åŒæ—¶ä»å¤´å¼€å§‹æ­å»ºä¸€ä¸ªæ›´åŠ ä¸€è‡´æ€§çš„æ„æ¶. æ·»åŠ äº†æ§åˆ¶é¢æ¿, è°ƒåº¦å™¨ç­‰ç­‰, ä»¥æ­¤æ¥ä¼˜åŒ–å¶å°”å‘ç”Ÿçš„èµ„æºå†²çªé—®é¢˜.  åŒå¹´, docker æ­£å¼å‡ºé“.</p>
  </li>
  <li>
    <p>2014 å¹´å·¦å³, Google å‘å¸ƒäº† kubernates. åŒå¹´, Microsoft, Red Hat, IBM, Docker ç­‰åŠ å…¥ kubernates ç¤¾åŒº</p>
  </li>
  <li>
    <p>2015 å¹´, æˆç«‹äº† CNCF åŸºé‡‘ä¼š, æ‰˜ç®¡ kubernates</p>
  </li>
  <li>
    <p>2016 å¹´å·¦å³, kubernates æˆä¸ºä¸»æµ.</p>

    <p>åœ¨ CloudNative 2016 å¤§ä¼šä¸Š, æ¥è‡ªå…¨ä¸–ç•Œçš„è´¡çŒ®å€¼å’Œå¼€å‘è€…ä¸€èµ·äº¤æµkubernates, Fluentd, Promethuesç­‰äº‘åŸç”ŸæŠ€æœ¯(é‡‡ç”¨å¼€æºå †æ ˆ K8S+Docker è¿›è¡Œå®¹å™¨åŒ–ï¼ŒåŸºäºå¾®æœåŠ¡æ¶æ„æé«˜çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå€ŸåŠ©æ•æ·æ–¹æ³•ã€DevOpsæ”¯æŒæŒç»­è¿­ä»£å’Œè¿ç»´è‡ªåŠ¨åŒ–ï¼Œåˆ©ç”¨äº‘å¹³å°è®¾æ–½å®ç°å¼¹æ€§ä¼¸ç¼©ã€åŠ¨æ€è°ƒåº¦ã€ä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡)</p>
  </li>
  <li>
    <p>2017 å¹´å·¦å³, å„å¤§äº’è”ç½‘å‚å•†å¼€å§‹çº·çº·æ”¯æŒ kubernates. åŒå¹´, istio æ­£å¼å‡ºé“. Docker å®¹å™¨å¤§æˆ˜æ­£å¼ç»“æŸ, æˆåŠŸä¸Šä½, ä½œä¸º kubernates å®¹å™¨è¿è¡Œæ—¶çš„æ ‡é….</p>
  </li>
  <li>
    <p>2018 å¹´å·¦å³, æ— äººä¸çŸ¥ kubernates. å›½å†…ä¸è®ºå¤§å°å‚å•†å¼€å§‹è¿›è¡Œäº‘åŸç”Ÿè½åœ°.</p>
  </li>
</ol>

<h3 id="borgomegak8så…³è”">Borg/Omega/K8Så…³è”</h3>

<p>è¯¦æƒ…è§: <a href="https://queue.acm.org/detail.cfm?id=2898444">https://queue.acm.org/detail.cfm?id=2898444</a></p>

<h3 id="k8sç‰¹ç‚¹">k8sç‰¹ç‚¹</h3>

<ol>
  <li>å¯ç§»æ¤æ€§: æ”¯æŒå…¬æœ‰äº‘, ç§æœ‰äº‘, æ··åˆäº‘, å¤šé‡äº‘</li>
  <li>å¯æ‰©å±•æ€§: æ¨¡å—åŒ–, æ’ä»¶åŒ–, å¯æŒ‚è½½, å¯ç»„åˆ</li>
  <li>è‡ªåŠ¨åŒ–: è‡ªåŠ¨éƒ¨ç½², è‡ªåŠ¨é‡å¯, è‡ªåŠ¨å¤åˆ¶, è‡ªåŠ¨ä¼¸ç¼©/æ‰©å±•</li>
</ol>

<h2 id="k8s-è¯¥å¦‚ä½•ä½¿ç”¨">k8s è¯¥å¦‚ä½•ä½¿ç”¨</h2>

<h3 id="ç¯å¢ƒå‡†å¤‡ç¯‡">ç¯å¢ƒå‡†å¤‡ç¯‡</h3>

<h4 id="æœ¬åœ°å¼€å‘ç¯å¢ƒ">æœ¬åœ°å¼€å‘ç¯å¢ƒ</h4>
<p>è¯¦æƒ…è§: <a href="https://github.com/chaimch/k8s-for-docker-desktop">https://github.com/chaimch/k8s-for-docker-desktop</a></p>

<h4 id="äº‘ç¾Šæ¯›ç¯å¢ƒ">äº‘ç¾Šæ¯›ç¯å¢ƒ</h4>
<p>GCP ç¾Šæ¯›, è¯¦æƒ…è§: <a href="https://console.cloud.google.com/freetrial">https://console.cloud.google.com/freetrial</a></p>

<p>katacodaç¾Šæ¯›, è¯¦æƒ…è§: <a href="https://katacoda.com/learn">https://katacoda.com/learn</a></p>

<h3 id="å…¥é—¨">å…¥é—¨</h3>

<h4 id="è‡ªåŠ¨è¡¥å…¨æç¤º">è‡ªåŠ¨è¡¥å…¨æç¤º</h4>
<ol>
  <li>å®‰è£… bash-completion <code class="language-plaintext highlighter-rouge">yum install bash-completion</code></li>
  <li>è®¾ç½® kubectl çš„åˆ«ç§° <code class="language-plaintext highlighter-rouge">alias k=kubectl</code></li>
  <li>bash ç¯å¢ƒä¸‹, è°ƒæ•´åˆ«ç§° k çš„è‡ªåŠ¨è¡¥å…¨ <code class="language-plaintext highlighter-rouge">source &lt;(kubectl completion bash | sed s/kubectl/k/g)</code></li>
  <li>zsh ç¯å¢ƒä¸‹, è°ƒæ•´ k çš„è‡ªåŠ¨è¡¥å…¨ <code class="language-plaintext highlighter-rouge">source &lt;(kubectl completion zsh)</code></li>
  <li>è®¾ç½®åˆ‡æ¢åç§°ç©ºé—´åˆ«ç§° <code class="language-plaintext highlighter-rouge">alias kcd='k config set-context $(k config current-context) --namespace'</code></li>
</ol>

<h4 id="hello-world">hello world</h4>

<p>åˆ›å»ºé…ç½®</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-deployment</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.7.9</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>åˆ›å»ºåº”ç”¨</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> æˆ‘çš„é…ç½®æ–‡ä»¶
</code></pre></div></div>

<p>æŸ¥çœ‹åº”ç”¨</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>nginx
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-67594d6bf6-9gdvr   1/1       Running   0          10m
nginx-deployment-67594d6bf6-v6j7w   1/1       Running   0          10m
</code></pre></div></div>

<h4 id="kubernates-å®˜æ–¹">Kubernates å®˜æ–¹</h4>

<p>è¯¦æƒ…è§: <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">https://kubernetes.io/docs/tutorials/kubernetes-basics/</a></p>

<h3 id="ä¸ºä»€ä¹ˆéœ€è¦-pod">ä¸ºä»€ä¹ˆéœ€è¦ Pod</h3>

<p>å®¹å™¨çš„æœ¬è´¨æ˜¯è¿›ç¨‹, Kubernates çš„æœ¬è´¨æ˜¯æ“ä½œç³»ç»Ÿ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pstree <span class="nt">-g</span>
systemd<span class="o">(</span>1<span class="o">)</span>-+-accounts-daemon<span class="o">(</span>1984<span class="o">)</span>-+-<span class="o">{</span>gdbus<span class="o">}(</span>1984<span class="o">)</span>
           | <span class="sb">`</span>-<span class="o">{</span>gmain<span class="o">}(</span>1984<span class="o">)</span>
           |-acpid<span class="o">(</span>2044<span class="o">)</span>
          ...      
           |-lxcfs<span class="o">(</span>1936<span class="o">)</span>-+-<span class="o">{</span>lxcfs<span class="o">}(</span>1936<span class="o">)</span>
           | <span class="sb">`</span>-<span class="o">{</span>lxcfs<span class="o">}(</span>1936<span class="o">)</span>
           |-mdadm<span class="o">(</span>2135<span class="o">)</span>
           |-ntpd<span class="o">(</span>2358<span class="o">)</span>
           |-polkitd<span class="o">(</span>2128<span class="o">)</span>-+-<span class="o">{</span>gdbus<span class="o">}(</span>2128<span class="o">)</span>
           | <span class="sb">`</span>-<span class="o">{</span>gmain<span class="o">}(</span>2128<span class="o">)</span>
           |-rsyslogd<span class="o">(</span>1632<span class="o">)</span>-+-<span class="o">{</span><span class="k">in</span>:imklog<span class="o">}(</span>1632<span class="o">)</span>
           |  |-<span class="o">{</span><span class="k">in</span>:imuxsock<span class="o">)</span> S 1<span class="o">(</span>1632<span class="o">)</span>
           | <span class="sb">`</span>-<span class="o">{</span>rs:main Q:Reg<span class="o">}(</span>1632<span class="o">)</span>
           |-snapd<span class="o">(</span>1942<span class="o">)</span>-+-<span class="o">{</span>snapd<span class="o">}(</span>1942<span class="o">)</span>
           |  |-<span class="o">{</span>snapd<span class="o">}(</span>1942<span class="o">)</span>
           |  |-<span class="o">{</span>snapd<span class="o">}(</span>1942<span class="o">)</span>
           |  |-<span class="o">{</span>snapd<span class="o">}(</span>1942<span class="o">)</span>
           |  |-<span class="o">{</span>snapd<span class="o">}(</span>1942<span class="o">)</span>
</code></pre></div></div>

<p>åœ¨çœŸæ­£çš„æ“ä½œç³»ç»Ÿä¸­, è¿›ç¨‹å¾€å¾€æ˜¯ä»¥è¿›ç¨‹ç»„çš„æ–¹å¼è¢«ç»„ç»‡åœ¨ä¸€èµ·. æ¯”å¦‚ rsyslogd ç¨‹åº, è´Ÿè´£ linux æ—¥å¿—å¤„ç†. å…¶ä¸­ä¸»ç¨‹åº main, å’Œå†…æ ¸æ—¥å¿—æ¨¡å— imklog ç­‰åŒå±äº 1632 è¿›ç¨‹ç»„. è¿™äº›è¿›ç¨‹ä¹‹é—´ç›¸äº’åä½œ.</p>

<p>å¦‚æœå°† rsyslogd åº”ç”¨å®¹å™¨åŒ–, ç”±äºå—é™äºå®¹å™¨çš„â€œå•è¿›ç¨‹æ¨¡å‹â€(å®¹å™¨æ²¡æœ‰ç®¡ç†å¤šä¸ªè¿›ç¨‹çš„èƒ½åŠ›)ï¼Œè¿™ä¸‰ä¸ªæ¨¡å—å¾€å¾€éœ€è¦è¢«åˆ†åˆ«åˆ¶ä½œæˆä¸‰ä¸ªä¸åŒçš„å®¹å™¨. ä¸€æ—¦ main å®¹å™¨æ‰€åœ¨çš„èŠ‚ç‚¹ä¸è¶³ä»¥æ‰¿æ‹…ä¸‰ä¸ªå®¹å™¨åŒæ—¶è¿è¡Œæ—¶å€™, å°±å®¹æ˜“å‡ºç°æˆç»„è°ƒåº¦é—®é¢˜.</p>

<p>ä½†æ˜¯åœ¨ Kubernates ä¸­å°±å­˜åœ¨è¿™ç§é—®é¢˜, Pod æ˜¯ Kubernetes é‡Œçš„åŸå­è°ƒåº¦å•ä½, ç»Ÿä¸€æŒ‰ç…§ Pod è€Œéå®¹å™¨çš„èµ„æºéœ€æ±‚è¿›è¡Œè®¡ç®—è°ƒåº¦. ä¸€èˆ¬å®¹å™¨é—´ä¼šå‘ç”Ÿç›´æ¥çš„æ–‡ä»¶äº¤æ¢, ä½¿ç”¨ localhost æˆ– socket æ–‡ä»¶è¿›è¡Œæœ¬åœ°é€šä¿¡, éå¸¸é¢‘ç¹çš„è¿œç¨‹è°ƒç”¨, å…±äº« ns ç­‰é€‚åˆéœ€è¦å°†å¤šä¸ªå®¹å™¨æ”¾åˆ°åŒä¸€ä¸ª pod ä¸­.</p>

<h4 id="pod-å®ç°åŸç†">pod å®ç°åŸç†</h4>

<p>Pod é‡Œçš„æ‰€æœ‰å®¹å™¨, å…±äº«çš„æ˜¯åŒä¸€ä¸ª Network Namespace, å¹¶ä¸”å¯ä»¥å£°æ˜å…±äº«åŒä¸€ä¸ª Volume.</p>

<p>Kubernates çœŸæ­£å¤„ç†çš„è¿˜æ˜¯ linux å®¹å™¨çš„ ns å’Œ cgroups, ä¸å¹¶å­˜åœ¨ pod çš„è¾¹ç•Œæˆ–è€…éš”ç¦»ç¯å¢ƒ. pod é‡Œæ‰€æœ‰çš„å®¹å™¨, å…±äº«åŒä¸€ä¸ª network namespace, å¹¶ä¸”å¯ä»¥å£°æ˜å…±äº«åŒä¸€ volume. ç›¸å½“äº A å’Œ B ä¸¤ä¸ªå®¹å™¨çš„ pod, ç­‰åŒäºå®¹å™¨ A å…±äº«å®¹å™¨ B çš„ç½‘ç»œå’Œ volume.</p>

<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤å°±å¯ä»¥å®ç°</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--net</span><span class="o">=</span>B <span class="nt">--volumes-from</span><span class="o">=</span>B <span class="nt">--name</span><span class="o">=</span>A image-A
</code></pre></div></div>

<p>ä½†æ˜¯, ä¸Šè¿°çš„æ–¹å¼å­˜åœ¨ä¸€ä¸ªé—®é¢˜. B å®¹å™¨å¿…é¡»è¦åœ¨ A å®¹å™¨ä¹‹å‰å¯åŠ¨, ä¾æ¬¡ç±»æ¨å¤šä¸ªå®¹å™¨ä¹‹å‰å°±éœ€è¦å»ç»´æŠ¤æ‹“æ‰‘å…³ç³». å› æ­¤åœ¨ Kubernates ä¸­ä¼šç›´æ¥é¦–å…ˆåˆ›å»ºä¸€ä¸ª infra çš„å®¹å™¨, è¿™æ ·å…¶ä»–çš„å®¹å™¨å°±å¯ä»¥ç›´æ¥ä»¥ Join Network Namespace æ–¹å¼åŠ å…¥è¿›æ¥, å…¶ä»–çš„å®¹å™¨ç›´æ¥å°±åªæ˜¯å¯¹ç­‰å…³ç³», å½¼æ­¤ä¸ä¼šç›¸äº’ä¾èµ–.</p>

<h5 id="å®¹å™¨è®¾è®¡æ¨¡å¼">å®¹å™¨è®¾è®¡æ¨¡å¼</h5>

<p>è¯¦æƒ…è§: <a href="https://www.usenix.org/conference/hotcloud16/workshop-program/presentation/burns">https://www.usenix.org/conference/hotcloud16/workshop-program/presentation/burns</a></p>

<p>æ ¸å¿ƒæ€æƒ³: Pod å¯¹åº”ä¼ ç»Ÿç¯å¢ƒçš„æœºå™¨, å®¹å™¨å¯¹åº”æœºå™¨ä¸­çš„ç”¨æˆ·ç¨‹åº. æ•…å‡¡æ˜¯è°ƒåº¦, ç½‘ç»œ, å­˜å‚¨, ä»¥åŠå®‰å…¨ç›¸å…³çš„å±æ€§, åŸºæœ¬éƒ½æ˜¯ Pod çº§åˆ«.</p>

<h5 id="pod-è¿›é˜¶ç©æ³•">pod è¿›é˜¶ç©æ³•</h5>

<p>ä¼ ç»Ÿçš„ pod å£°æ˜å¦‚ä¸‹, å­—æ®µè¿‡å¤š, ä¸šåŠ¡ä¸è¿ç»´ä¸åˆ†å®¶</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">website</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">website</span>
    <span class="na">role</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">podpreset.admission.kubernetes.io/podpreset-allow-database</span><span class="pi">:</span> <span class="s2">"</span><span class="s">resource</span><span class="nv"> </span><span class="s">version"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">website</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
      <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/cache</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">cache-volume</span>
      <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DB_PORT</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">6379"</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cache-volume</span>
      <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>å¼€å‘äººå‘˜æäº¤çš„ pod å£°æ˜å¦‚ä¸‹</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">website</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">website</span>
    <span class="na">role</span><span class="pi">:</span> <span class="s">frontend</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">website</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
      <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>è¿ç»´äººå‘˜å®šä¹‰ PodPreset å¯¹è±¡, ç”±è¿ç»´ç®¡æ§çº¿ä¸Šç¯å¢ƒçš„ labels, env, volumes, volumeMount ç­‰</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">settings.k8s.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PodPreset</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">allow-database</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">role</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">env</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DB_PORT</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">6379"</span>
  <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/cache</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">cache-volume</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cache-volume</span>
      <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>åˆ›å»º pod</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> preset.yaml
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> pod.yaml
</code></pre></div></div>

<h3 id="æ¶æ„å›¾">æ¶æ„å›¾</h3>

<p><img src="https://cdn.jsdelivr.net/gh/chaimch/FigureBed@master/uPic/architecture.png" alt="architecture" /></p>

<h3 id="ç»„ä»¶åŠŸèƒ½">ç»„ä»¶åŠŸèƒ½</h3>

<h4 id="kubectl">kubectl</h4>
<p>å®˜æ–¹æä¾›çš„ CLI, å¯ä»¥ä»¥äº¤äº’å¼å¯¹ Kubernates API Server è¿›è¡Œæ“ä½œ. kubectl å‘é€ç›¸åº”çš„ http è¯·æ±‚, ç”± Kubernates API Server å¤„ç†åè¿”å›å¹¶å±•ç¤ºå‡ºç»“æœ.</p>

<h4 id="kube-apiserver">kube-apiserver</h4>

<p>è´Ÿè´£å°† Kubernates çš„èµ„æºç»„/èµ„æºç‰ˆæœ¬/èµ„æºä»¥ restful é£æ ¼çš„å½¢å¼å¯¹å¤–æš´éœ²å¹¶æä¾›æœåŠ¡. Kubernates é›†ç¾¤ä¸­çš„æ‰€æœ‰ç»„ä»¶éƒ½é€šè¿‡ kube-apiserver ç»„ä»¶æ“ä½œèµ„æºå¯¹è±¡.</p>

<h5 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h5>

<ol>
  <li>æ‰€æœ‰èµ„æºå¯¹è±¡éƒ½å°è£…æˆ restful é£æ ¼çš„ api æ¥å£è¿›è¡Œç®¡ç†</li>
  <li>é›†ç¾¤çŠ¶æ€ç®¡ç†å’Œæ•°æ®ç®¡ç†, æ˜¯å”¯ä¸€ä¸ etcd é›†ç¾¤äº¤äº’çš„ç»„ä»¶</li>
  <li>æ‹¥æœ‰ä¸°å¯Œçš„é›†ç¾¤å®‰å…¨è®¿é—®æœºåˆ¶, ä»¥åŠè®¤è¯, æˆæƒåŠå‡†å…¥æ§åˆ¶å™¨</li>
</ol>

<h4 id="kube-controller-manager">kube-controller-manager</h4>

<p>ç®¡ç† Kubernates é›†ç¾¤ä¸­NodeèŠ‚ç‚¹, Podå‰¯æœ¬, æœåŠ¡, Endpointç«¯ç‚¹, Namespace å‘½åç©ºé—´, Service Account æœåŠ¡è´¦æˆ·, ResourceQuota ç­‰. eg: æŸä¸ªèŠ‚ç‚¹å®•æœºæ—¶å€™,  Controller Manager ä¼šåŠæ—¶å‘ç°å¹¶æ‰§è¡Œè‡ªåŠ¨åŒ–ä¿®å¤æµç¨‹.</p>

<p>Controller Manager å…·å¤‡é«˜å¯ç”¨æ€§, åŸºäº etcd é›†ç¾¤ä¸Šçš„åˆ†å¸ƒå¼é”å®ç°é¢†å¯¼è€…é€‰ä¸¾æœºåˆ¶. å¤šä¸ªå®ä¾‹åŒæ—¶è¿è¡Œ,  é€šè¿‡ kube-apiserver æä¾›çš„èµ„æºé”è¿›è¡Œé€‰ä¸¾ç«äº‰.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç®€åŒ–ç‰ˆæœ¬çš„ Kubernates æ¶æ„å›¾</th>
      <th style="text-align: center">ç®€æ˜“ç‰ˆæœ¬å†°ç®±æ¶æ„</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/chaimch/FigureBed@master/uPic/image-20200908125907635.png" alt="image-20200908125907635" /></td>
      <td style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/chaimch/FigureBed@master/uPic/image-20200908130029579.png" alt="image-20200908130029579" /></td>
    </tr>
  </tbody>
</table>

<p>ç±»ä¼¼å†°ç®±ä¸€æ ·, å¯¹ Kubernates çš„æ“ä½œéƒ½éœ€è¦ç»Ÿä¸€çš„å…¥å£ç®¡ç†, å³é€šè¿‡ api-server .</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">å†°ç®± V1.0</th>
      <th style="text-align: center">å†°ç®± V2.0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/chaimch/FigureBed@master/uPic/image-20200908131150235.png" alt="image-20200908131150235" /></td>
      <td style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/chaimch/FigureBed@master/uPic/image-20200908131220428.png" alt="image-20200908131220428" /></td>
    </tr>
  </tbody>
</table>

<p>æ§åˆ¶å™¨ä¸“é—¨ç”¨äºæ§åˆ¶å„ä¸ªç³»ç»Ÿçš„çŠ¶æ€. æ‰“å¼€é—¨æ—¶å€™, æ§åˆ¶å™¨ç›‘æ§åˆ°é—¨çš„å˜åŒ–, æ›¿ç”¨æˆ·æ‰“å¼€ç¯. ç”¨æˆ·æŒ‰ä¸‹æ¸©æ§å™¨æ—¶å€™, æ§åˆ¶å™¨è§‚å¯Ÿåˆ°ç”¨æˆ·è®¾ç½®çš„æ¸©åº¦, åˆ™å®ƒæ›¿ç”¨æˆ·å»ç®¡ç†åˆ¶å†·ç³»ç»Ÿ.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">å†°ç®± V3.0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/chaimch/FigureBed@master/uPic/image-20200908131321132.png" alt="image-20200908131321132" /></td>
    </tr>
  </tbody>
</table>

<h4 id="kube-scheduler">kube-scheduler</h4>

<p>Kubernates é›†ç¾¤çš„é»˜è®¤è°ƒåº¦å™¨, ä¸»è¦è´Ÿè´£åœ¨ Kubernates é›†ç¾¤ä¸­ä¸ºä¸€ä¸ª Pod èµ„æºå¯¹è±¡æ‰¾åˆ°åˆé€‚çš„èŠ‚ç‚¹, å¹¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œ. è¯¥è°ƒåº¦å™¨ä¸ºæ¯ä¸ª Pod å¯»æ‰¾åˆé€‚èŠ‚ç‚¹çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºè°ƒåº¦å‘¨æœŸ, ä¸€ä¸ªè°ƒåº¦å‘¨æœŸä¹‹å†…åªè°ƒåº¦ä¸€ä¸ª Pod èµ„æºå¯¹è±¡. è¯¥ç»„ä»¶ç›‘æ§æ•´ä¸ªé›†ç¾¤çš„ Pod èµ„æºå¯¹è±¡å’Œ Node èµ„æºå¯¹è±¡, ä¸€æ—¦æœ‰æ–°çš„ Pod èµ„æºå¯¹è±¡æ—¶, ä¼šé€šè¿‡è°ƒåº¦ç®—æ³•ä¸ºå…¶é€‰æ‹©æœ€ä¼˜çš„èŠ‚ç‚¹.</p>

<h4 id="kubelet">kubelet</h4>

<p>è¯¥ç»„ä»¶è¿è¡Œåœ¨æ¯ä¸ª Kubernates é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¸Š, ç”¨äºæ¥æ”¶, å¤„ç†, ä¸ŠæŠ¥ kube-apiserver ç»„ä»¶ä¸‹å‘çš„ä»»åŠ¡.</p>

<p>Kubelet è¿›ç¨‹å¯åŠ¨æ—¶ä¼šå‘ Kube-apiserver æ³¨å†ŒèŠ‚ç‚¹è‡ªèº«ä¿¡æ¯, å®šæ—¶ä¸ŠæŠ¥æ‰€åœ¨èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨çŠ¶æ€, ç”¨ä»¥å¸®åŠ©kube-schedule è°ƒåº¦å™¨ä¸º Pod èµ„æºå¯¹è±¡é¢„é€‰èŠ‚ç‚¹.</p>

<p>åŒæ—¶è´Ÿè´£æ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„ Pod èµ„æºå¯¹è±¡çš„ç®¡ç†(Pod èµ„æºå¯¹è±¡çš„åˆ›å»º, ä¿®æ”¹, ç›‘æ§, åˆ é™¤, é©±é€åŠPod å£°æ˜å‘¨æœŸç®¡ç†ç­‰), å¯¹æ‰€åœ¨èŠ‚ç‚¹çš„é•œåƒå’Œå®¹å™¨åšä¸€äº›æ¸…ç†å·¥ä½œ, ä¿è¯èŠ‚ç‚¹ä¸Šçš„é•œåƒä¸ä¼šå æ»¡ç£ç›˜ç©ºé—´, åˆ é™¤å®¹å™¨é‡Šæ”¾ç›¸å…³èµ„æº.</p>

<p>kubelet å¼€æ”¾çš„æ¥å£, CRI å®¹å™¨è¿è¡Œæ—¶æ¥å£, CNI å®¹å™¨ç½‘ç»œæ¥å£, CSI å®¹å™¨å­˜å‚¨æ¥å£.</p>

<h4 id="kube-proxy">kube-proxy</h4>

<p>èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œä»£ç†, ç›‘æ§ kube-apiserver æœåŠ¡äºç«¯ç‚¹èµ„æºå˜åŒ–, åŒæ—¶å¯ä»¥é€šè¿‡ iptables/ipvs ç­‰é…ç½®è´Ÿè½½å‡è¡¡å™¨, ä¸ºä¸€ç»„ pod æä¾›ç»Ÿä¸€çš„ tcp/udp çš„æµé‡è½¬å‘å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½.</p>

<h3 id="k8sä½œä¸šè°ƒåº¦ä¸èµ„æºç®¡ç†">k8sä½œä¸šè°ƒåº¦ä¸èµ„æºç®¡ç†</h3>

<h4 id="åŸºæœ¬çš„èµ„æºé™åˆ¶">åŸºæœ¬çš„èµ„æºé™åˆ¶</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">frontend</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">db</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">env</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">password"</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">64Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">128Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">wp</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">wordpress</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">64Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">128Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">500m"</span>
</code></pre></div></div>

<p>CPU çš„èµ„æºè¢«ç§°ä¸ºâ€å¯å‹ç¼©èµ„æºâ€, èµ„æºä¸è¶³æ—¶, Podå¹¶ä¸ä¼šé€€å‡º. å†…å­˜è¿™ç§èµ„æºä¸ºâ€ä¸å¯å‹ç¼©èµ„æºâ€, èµ„æºä¸è¶³æ—¶å€™å°±ä¼šè¢« OOM æ€æ‰.</p>

<p>å…¶ä¸­èµ„æºä¸€èˆ¬è¿˜ä¼šæœ‰ limits å’Œ requests å€¼, è°ƒåº¦çš„æ—¶å€™, kube-scheduler ä¼šæŒ‰ç…§ requests çš„å€¼è¿›è¡Œè®¡ç®—, ä½†æ˜¯åœ¨è®¾ç½® cgroups é™åˆ¶æ—¶å€™, åˆ™ä¼šä½¿ç”¨ limits çš„å€¼æ¥è¿›è¡Œè®¾ç½®.</p>

<h4 id="èµ„æºåˆ†çº§">èµ„æºåˆ†çº§</h4>

<h5 id="guaranteed-ç±»åˆ«">Guaranteed ç±»åˆ«</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">qos-demo</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">qos-example</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">qos-demo-ctr</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">200Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">700m"</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">200Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">700m"</span>
</code></pre></div></div>

<p>pod ä¸­çš„æ¯ä¸ª container éƒ½åŒæ—¶è®¾ç½® requests å’Œ limits, ä¸” requests å’Œ limits çš„å€¼ç›¸ç­‰.</p>

<p>pod è¢«åˆ›å»ºå‡ºæ¥ä¹‹å, å®ƒçš„ qosClass å­—æ®µå°±ä¼šè¢« Kubernates è‡ªåŠ¨è®¾ç½®ä¸º Guaranteed.</p>

<p>å½“ä»…è®¾ç½® limits æ²¡æœ‰ requests æ—¶å€™, Kubernates ä¼šè‡ªåŠ¨è®¾ç½®ä¸ limits ç›¸åŒçš„ requests å€¼, æ­¤æ—¶ä¹Ÿå±äº Guaranteed æƒ…å†µ</p>

<h5 id="burstable-ç±»åˆ«">Burstable ç±»åˆ«</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">qos-demo-2</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">qos-example</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">qos-demo-2-ctr</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="s">limits</span>
        <span class="s">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">200Mi"</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">100Mi"</span>
</code></pre></div></div>

<p>å½“ pod ä¸æ»¡è¶³ Guaranteed æ¡ä»¶, ä½†è‡³å°‘æœ‰ä¸€ä¸ª Container è®¾ç½®äº† requests, æ­¤æ—¶å±äº Burstable ç±»åˆ«</p>

<h5 id="besteffort-ç±»åˆ«">BestEffort ç±»åˆ«</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">qos-demo-3</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">qos-example</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">qos-demo-3-ctr</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
</code></pre></div></div>

<p>å¦‚æœä¸€ä¸ª pod æ—¢æ²¡æœ‰ requests, ä¹Ÿæ²¡æœ‰ limits, åˆ™æ­¤æ—¶è¢«å½’ä¸º BestEffort</p>

<h4 id="eviction--èµ„æºå›æ”¶">Eviction / èµ„æºå›æ”¶</h4>

<p>å½“ Kubernates æ‰€åœ¨çš„å®¿ä¸»æœºä¸Šä¸å¯èµ„æºçŸ­ç¼ºæ—¶, ä¾‹å¦‚memory.available å†…å­˜, nodefs.available å®¿ä¸»æœºç£ç›˜ç©ºé—´, imagefs.available é•œåƒå­˜å‚¨ç©ºé—´ç­‰ä¸è¶³æ—¶å€™, å°±ä¼šè§¦å‘ Eviction.</p>

<p>å¸¸è§çš„ Eviction é»˜è®¤é˜ˆå€¼å¦‚ä¸‹</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>memory.available&lt;100Mi
nodefs.available&lt;10%
nodefs.inodesFree&lt;5%
imagefs.available&lt;15%
</code></pre></div></div>

<p>è‡ªå®šä¹‰èµ„æºå›æ”¶</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubelet <span class="nt">--eviction-hard</span><span class="o">=</span>imagefs.available&lt;10%,memory.available&lt;500Mi,nodefs.available&lt;5%,nodefs.inodesFree&lt;5% <span class="se">\</span>
					<span class="nt">--eviction-soft</span><span class="o">=</span>imagefs.available&lt;30%,nodefs.available&lt;10% <span class="se">\</span>
					<span class="nt">--eviction-soft-grace-period</span><span class="o">=</span>imagefs.available<span class="o">=</span>2m,nodefs.available<span class="o">=</span>2m <span class="se">\</span>
					<span class="nt">--eviction-max-pod-grace-period</span><span class="o">=</span>600
</code></pre></div></div>

<p>Soft Eviction å…è®¸ä¸º Eviction è¿‡ç¨‹è®¾ç½®ä¸€æ®µä¼˜é›…æ€æ­»çš„æ—¶é—´, <code class="language-plaintext highlighter-rouge">imagefs.available=2m</code> è¡¨ç¤ºimagefs ä¸è¶³çš„é˜ˆå€¼è¾¾åˆ° 2 åˆ†é’Ÿå, æ‰å¼€å§‹è¿›è¡Œ Eviction.</p>

<p>Hard Eviction æ¨¡å¼ä¸‹, Eviction åœ¨è¾¾åˆ°é˜ˆå€¼åå°±ç«‹åˆ»å¼€å§‹.</p>

<p>Eviction é˜ˆå€¼çš„æ•°æ®ä¸»è¦ä» cgroups å’Œ cAdvisor ä¸­è·å¾—. ä¸€æ—¦è¾¾åˆ°é˜ˆå€¼, å°±ä¼šè¿›å…¥ MemoryPressure æˆ–DiskPressure çŠ¶æ€(æ­¤æ—¶ä¼šæ‰“æ±¡ç‚¹æ ‡è®°), ä»è€Œé¿å…æ–°çš„ Pod è¢«è°ƒåº¦è¯¥èŠ‚ç‚¹ä¸Š. å½“ Eviction å‘ç”Ÿæ—¶å€™æŒ‰ç…§å¦‚ä¸‹é¡ºåºè°ƒåº¦ Pod:</p>

<ol>
  <li>BestEffort ç±»åˆ«çš„ Pod</li>
  <li>Burstable ç±»åˆ«, å¹¶ä¸”èµ„æºä½¿ç”¨é‡å·²ç»è¶…è¿‡ requests çš„ pod</li>
  <li>Guaranteed ç±»åˆ«èµ„æº, ä»…å½“ pod èµ„æºä½¿ç”¨é‡è¶…è¿‡äº† limits é™åˆ¶, æˆ–å®¿ä¸»æœºæœ¬èº«å¤„äº Memory Pressure çŠ¶æ€æ—¶å€™, è¯¥ç±»åˆ«æ‰ä¼šè¢«é€‰ä¸­è¿›è¡Œ Eviction.</li>
  <li>åŒ Qos ç±»åˆ«çš„ Pod ä¹Ÿä¼šæœ‰ä¸€å®šçš„ä¼˜å…ˆçº§.</li>
</ol>

<h4 id="ç‹¬äº«-cpu">ç‹¬äº« cpu</h4>

<p>å®¹å™¨ä¸­</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker run -it --rm --cpuset-cpus="1" u-stress:latest /bin/bash
</code></pre></div></div>

<p>Kubernates ä¸­, ä¿è¯ Pod ä¸º Guaranteed ç±»åˆ«, ä¸”å°† CPU èµ„æºçš„ requests å’Œ limits è®¾ç½®ä¸ºåŒä¸€ä¸ªç›¸ç­‰çš„æ•´æ•°å€¼</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">200Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
      <span class="na">requests</span><span class="pi">:</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">200Mi"</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
</code></pre></div></div>

<p>cpuset å¯æŠŠå®¹å™¨ç»‘å®šåˆ°æŒ‡å®šçš„ cpu æ ¸ä¸Š, é¿å… cpushare æ¥å…±äº« cpu çš„è®¡ç®—èƒ½åŠ›. æ­¤æ—¶å¯ä»¥å¤§å¤§å‡å°‘ cpu ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°, æ€§èƒ½ä¼šæé«˜å¾ˆå¤š</p>

<h4 id="é»˜è®¤è°ƒåº¦å™¨">é»˜è®¤è°ƒåº¦å™¨</h4>

<p>ä¸ºæ–°åˆ›å»ºå‡ºæ¥çš„ pod å¯»æ‰¾æœ€åˆé€‚çš„èŠ‚ç‚¹.</p>

<ol>
  <li>åœ¨é›†ç¾¤æ‰€æœ‰çš„èŠ‚ç‚¹ä¸­, æ ¹æ®è°ƒåº¦ç®—æ³•æŒ‘é€‰å‡ºæ‰€æœ‰å¯ä»¥å…è®¸è¯¥ pod çš„èŠ‚ç‚¹ -&gt; Predicate è°ƒåº¦ç®—æ³•</li>
  <li>ä» 1 çš„ç»“æœä¸­, æ ¹æ®è°ƒåº¦ç®—æ³•é€‰æ‹©æœ€ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä¸ºæœ€ç»ˆç»“æœ -&gt; Priority è°ƒåº¦ç®—æ³•</li>
</ol>

<h5 id="predicate-è°ƒåº¦ç®—æ³•">Predicate è°ƒåº¦ç®—æ³•</h5>

<p>è¯¥ç®—æ³•æœ¬è´¨å°±æ˜¯ filter, æŒ‰ç…§è°ƒåº¦ç­–ç•¥ä»å½“å‰è®¡ç®—è¿‡æ»¤å‡ºä¸€ç³»åˆ—ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹</p>

<ol>
  <li>
    <p>GeneralPredicates è®¡ç®—å®¿ä¸»æœºçš„ CPU å’Œå†…å­˜èµ„æºæ˜¯å¦å¤Ÿç”¨, ç®€å•æ£€æŸ¥ä¸‹ Pod çš„ requests å­—æ®µ</p>
  </li>
  <li>
    <p>Volume è¿‡æ»¤, å®¹å™¨æŒä¹…åŒ–ç›¸å…³è°ƒåº¦ç­–ç•¥</p>

    <ol>
      <li>NoDiskConflict å†²çªæ£€éªŒ, å¤šä¸ª Pod å£°æ˜çš„ Volume æ˜¯å¦å†²çª. eg: AWS EVS çš„ Volume ä¸å…è®¸å¤šä¸ª Pod åŒæ—¶ä½¿ç”¨</li>
      <li>MaxPDVolumeCountPredicate æ£€éªŒæŸç§ç±»å‹çš„ Volume æ˜¯å¦è¶…è¿‡ä¸€å®šæ•°ç›®.</li>
      <li>VolumeZonePredicate æ£€æŸ¥ Zone é«˜å¯ç”¨æ ‡ç­¾æ˜¯å¦åŒ¹é…</li>
      <li>VolumeBindingPredicate æ£€æŸ¥ podå¯¹åº”çš„ PV çš„ nodeAffinity æ˜¯å¦è·ŸèŠ‚ç‚¹åŒ¹é…</li>
    </ol>
  </li>
  <li>
    <p>å®¿ä¸»æœºè¿‡æ»¤, æ£€éªŒå¾…è°ƒåº¦çš„ Pod æ˜¯å¦æ»¡è¶³ Node è‡ªèº«çš„æ¡ä»¶</p>

    <ol>
      <li>PodToleratesNodeTaints æ£€æŸ¥ Node çš„ Taint ä¸ Pod çš„ Toleration æ˜¯å¦åŒ¹é…, æ˜¯å¦å¯ä»¥è¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹</li>
      <li>NodeMemoryPressurePredicate æ£€æŸ¥å½“å‰èŠ‚ç‚¹çš„å†…å­˜æ˜¯å¦å·²ç»ä¸å¤Ÿå……è¶³</li>
    </ol>
  </li>
  <li>
    <p>Pod ç›¸å…³è¿‡æ»¤</p>

    <ol>
      <li>
        <p>PodAffinityPredicate æ£€æŸ¥å¾…è°ƒåº¦çš„ Pod ä¸ Node ä¹‹é—´çš„äº²å¯†å’Œåäº²å¯†å…³ç³»</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">with-pod-antiaffinity</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">affinity</span><span class="pi">:</span>
    <span class="na">podAntiAffinity</span><span class="pi">:</span> 
      <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="na">weight</span><span class="pi">:</span> <span class="s">100</span>  
        <span class="na">podAffinityTerm</span><span class="pi">:</span>
          <span class="na">labelSelector</span><span class="pi">:</span>
            <span class="na">matchExpressions</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">security</span> 
              <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span> 
              <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">S2</span>
          <span class="na">topologyKey</span><span class="pi">:</span> <span class="s">kubernetes.io/hostname</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">with-pod-affinity</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/ocpqe/hello-pod</span>
</code></pre></div>        </div>

        <p>å½“æºå¸¦ Key æ˜¯<code class="language-plaintext highlighter-rouge">kubernetes.io/hostname</code>æ ‡ç­¾çš„ Nodeä¸­(topologyKeyä½œç”¨),  pod ä¸å¸Œæœ›ä»»ä½•æºå¸¦ security=S2 æ ‡ç­¾ Pod å­˜åœ¨åŒä¸€ä¸ª Node ä¸­.</p>
      </li>
    </ol>
  </li>
</ol>

<p>ä¸€èˆ¬æƒ…å†µ k8s è°ƒåº¦å™¨ä¼šå¯åŠ¨ 16 ä¸ª Goroutine å¹¶å‘çš„ä¸ºé›†ç¾¤çš„æ‰€æœ‰ Node è®¡ç®— Predicates, æœ€åè¿”å›å¯ä»¥è¿è¡Œè¯¥ Pod çš„ Node åˆ—è¡¨</p>

<h5 id="priorities-ç®—æ³•">Priorities ç®—æ³•</h5>

<p>Priorities ä¸ºç­›é€‰å‡ºæ¥çš„èŠ‚ç‚¹æ‰“åˆ†, 0-10 åˆ†åˆ¶, å¾—åˆ†æœ€é«˜çš„èŠ‚ç‚¹ä¼šè¢« Pod ç»‘å®š</p>

<ol>
  <li>
    <p>LeastRequestedPriority ä¼˜å…ˆé€‰æ‹© CPU å’Œ Memory æœ€å¤šçš„å®¿ä¸»æœº, è®¡åˆ†è§„åˆ™å¦‚ä¸‹</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>score <span class="o">=</span> <span class="o">(</span>cpu<span class="o">((</span>capacity-sum<span class="o">(</span>requested<span class="o">))</span>10/capacity<span class="o">)</span> + memory<span class="o">((</span>capacity-sum<span class="o">(</span>requested<span class="o">))</span>10/capacity<span class="o">))</span>/2
</code></pre></div>    </div>
  </li>
  <li>
    <p>BalancedResourceAllocation é€‰æ‹©æ‰€æœ‰èŠ‚ç‚¹ä¸­å„ç§èµ„æºåˆ†å¸ƒæœ€å‡è¡¡çš„èŠ‚ç‚¹, é¿å…ä¸€ä¸ªèŠ‚ç‚¹çš„ CPU è¢«å¤§é‡åˆ†é…, Memory å¤§é‡å‰©ä½™, è®¡åˆ†è§„åˆ™å¦‚ä¸‹</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>score <span class="o">=</span> 10 - variance<span class="o">(</span>cpuFraction,memoryFraction,volumeFraction<span class="o">)</span><span class="k">*</span>10
</code></pre></div>    </div>

    <p>Fraction å°±æ˜¯ Pod è¯·æ±‚çš„èµ„æº / èŠ‚ç‚¹ä¸Šçš„å¯ç”¨èµ„æº. varianceè®¡ç®—ä¸¤ç§èµ„æº Fraction ä¹‹é—´çš„å·®è·</p>
  </li>
  <li>
    <p>NodeAffinityPriority ç±»ä¼¼ PodMatchNodeSelector</p>
  </li>
  <li>
    <p>TaintTolerationPriority ç±»ä¼¼ PodToleratesNodeTaints</p>
  </li>
  <li>
    <p>InterPodAffinityPriority ç±»ä¼¼ PodAffinityPredicate</p>
  </li>
  <li>
    <p>ImageLocalityPriority å¦‚æœå¾…è°ƒåº¦çš„é•œåƒå¾ˆå¤§, ä¸”å·²ç»å­˜åœ¨äºæŸäº› Node ä¸­, åˆ™è¿™äº› Node å¾—åˆ†ä¼šç›¸å½“é«˜</p>
  </li>
</ol>

<p>ç”±äºé›†ç¾¤å’Œ Pod çš„ä¿¡æ¯å‡å·²ç¼“å­˜åŒ–, ä¸Šè¿°çš„ç®—æ³•æ‰§è¡Œè¿‡ç¨‹è¿˜æ˜¯å¾ˆå¿«çš„.</p>

<h3 id="æŠ¢å å¼è°ƒåº¦">æŠ¢å å¼è°ƒåº¦</h3>

<p>ä¸€èˆ¬åœ¨ Pod è°ƒåº¦æ—¶å€™æ—¶å€™, ç›´åˆ° Pod è¢«æ›´æ–°æˆ–è€…é›†ç¾¤çŠ¶æ€å‘é€å˜åŒ–, è°ƒåº¦å™¨æ‰ä¼šå¯¹è¯¥ Pod è¿›è¡Œé‡æ–°è°ƒåº¦. é’ˆå¯¹é«˜ä¼˜å…ˆçº§çš„ Pod è°ƒåº¦å¤±è´¥æ—¶, å¸Œæœ›å¯ä»¥æŒ¤èµ°æŸäº› Node ä¸Šä¼˜å…ˆçº§ä½çš„ Pod, ä¼˜å…ˆä¿éšœé«˜ä¼˜å…ˆçº§ Pod è°ƒåº¦æˆåŠŸ. åªéœ€è¦å®šä¹‰ PriorityClass, å¦‚ä¸‹æ‰€ç¤º</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">scheduling.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PriorityClass</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">high-priority</span>
<span class="na">value</span><span class="pi">:</span> <span class="m">1000000</span>
<span class="na">globalDefault</span><span class="pi">:</span> <span class="no">false</span>
<span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">This</span><span class="nv"> </span><span class="s">priority</span><span class="nv"> </span><span class="s">class</span><span class="nv"> </span><span class="s">should</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">used</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">high</span><span class="nv"> </span><span class="s">priority</span><span class="nv"> </span><span class="s">service</span><span class="nv"> </span><span class="s">pods</span><span class="nv"> </span><span class="s">only."</span>
</code></pre></div></div>

<p>Pod ä¸­ä½¿ç”¨é«˜ä¼˜å…ˆçº§</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">env</span><span class="pi">:</span> <span class="s">test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
  <span class="na">priorityClassName</span><span class="pi">:</span> <span class="s">high-priority</span>
</code></pre></div></div>

<p>è¯¥ pod çš„ spec.Priority ä¼šè¢«è®¾ç½®ä¸º 1000000, spec.</p>

:ET